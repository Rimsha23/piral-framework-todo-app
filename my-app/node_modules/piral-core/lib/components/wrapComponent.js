"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.wrapComponent = void 0;
const tslib_1 = require("tslib");
const React = tslib_1.__importStar(require("react"));
const PortalRenderer_1 = require("./PortalRenderer");
const ForeignComponentContainer_1 = require("./ForeignComponentContainer");
const hooks_1 = require("../hooks");
const utils_1 = require("../utils");
// this is an arbitrary start number to have 6 digits
let portalIdBase = 123456;
function wrapReactComponent(Component, captured, Wrapper) {
    return (props) => (React.createElement(Wrapper, { ...props },
        React.createElement(Component, { ...props, ...captured })));
}
function wrapForeignComponent(component, captured, Wrapper) {
    return React.memo((props) => {
        const { destroyPortal, navigation } = (0, hooks_1.useGlobalStateContext)();
        const id = React.useMemo(() => (portalIdBase++).toString(26), utils_1.none);
        // router added for backwards compatibility
        const context = React.useMemo(() => ({ publicPath: navigation.publicPath, navigation, router: navigation.router }), []);
        const innerProps = React.useMemo(() => ({ ...props, ...captured }), [props]);
        React.useEffect(() => () => destroyPortal(id), utils_1.none);
        return (React.createElement(Wrapper, { ...props },
            React.createElement(PortalRenderer_1.PortalRenderer, { id: id }),
            React.createElement(ForeignComponentContainer_1.ForeignComponentContainer, { innerProps: innerProps, "$portalId": id, "$component": component, "$context": context })));
    });
}
function isNotExotic(component) {
    return !component.$$typeof;
}
function wrapComponent(converters, component, captured, Wrapper) {
    if (!component) {
        const pilet = captured.piral.meta.name;
        console.error(`[${pilet}] The given value is not a valid component.`);
        // tslint:disable-next-line:no-null-keyword
        component = () => null;
    }
    if (typeof component === 'object' && isNotExotic(component)) {
        const result = (0, utils_1.convertComponent)(converters[component.type], component);
        return wrapForeignComponent(result, captured, Wrapper);
    }
    return wrapReactComponent(component, captured, Wrapper);
}
exports.wrapComponent = wrapComponent;
//# sourceMappingURL=wrapComponent.js.map